import React, { useCallback, useEffect, useState } from 'react';
import classManagementService from '../../services/classManagementService';
import {
    debounce,
    formatSchedule,
    getCurrentUserId,
    showConfirmDialog,
    showNotification,
    validateClassForm
} from '../../utils/courseManagementUtils';
import ScheduleManager from '../schedule/ScheduleManager';

const CreateClassModal = ({ visible, template, onCancel, onSuccess }) => {
  const [formData, setFormData] = useState({
    className: '',
    description: '',
    introVideoUrl: '', // Th√™m field cho video gi·ªõi thi·ªáu
    teacherId: null,
    roomId: null,
    educationLevel: '',
    startDate: '',
    endDate: '', 
    schedule: {
      days: [],
      startTime: '07:30',
      endTime: '09:30',
      duration: 120
    },
    maxStudents: 30,
    settings: {
      allowLateEnrollment: true,
      requireApproval: false,
      isPublic: true
    },
    validation: {}
  });

  const [state, setState] = useState({
    teachers: [],
    rooms: [],
    conflicts: [],
    schedule: [],
    scheduleAutoGenerated: false,
    scheduleValidation: null,
    activeStep: 1, // 1: Basic Info, 2: Schedule, 3: Review
    loading: {
      teachers: false,
      rooms: false,
      conflicts: false,
      submit: false
    },
    errors: {},
    lastTeacherQuery: null // Cache key cho teacher query
  });

  // Validate xem ng√†y b·∫Øt ƒë·∫ßu c√≥ h·ª£p l√Ω v·ªõi l·ªãch h·ªçc kh√¥ng
  const validateStartDateWithScheduleDays = (startDate, selectedDays) => {
    if (!startDate || !selectedDays.length) return { isValid: true };

    const start = new Date(startDate);
    const startDayOfWeek = start.getDay(); // 0=CN, 1=T2, 2=T3, ...

    // Mapping t·ª´ UI days sang JS days
    const dayMapping = {
      'monday': 1, 'tuesday': 2, 'wednesday': 3,
      'thursday': 4, 'friday': 5, 'saturday': 6, 'sunday': 0
    };

    const targetDays = selectedDays.map(day => dayMapping[day]).filter(d => d !== undefined);
    const dayNames = ['Ch·ªß nh·∫≠t', 'Th·ª© 2', 'Th·ª© 3', 'Th·ª© 4', 'Th·ª© 5', 'Th·ª© 6', 'Th·ª© 7'];

    // N·∫øu ng√†y b·∫Øt ƒë·∫ßu tr√πng v·ªõi m·ªôt trong c√°c ng√†y h·ªçc ‚Üí OK
    if (targetDays.includes(startDayOfWeek)) {
      return { isValid: true };
    }

    // N·∫øu kh√¥ng tr√πng, t√≠nh xem bu·ªïi h·ªçc ƒë·∫ßu ti√™n s·∫Ω di·ªÖn ra khi n√†o
    let currentDate = new Date(start);
    let daysToFirstLesson = 0;
    const maxDaysToCheck = 7; // Ch·ªâ t√¨m trong v√≤ng 1 tu·∫ßn

    while (daysToFirstLesson < maxDaysToCheck) {
      const dayOfWeek = currentDate.getDay();
      if (targetDays.includes(dayOfWeek)) {
        // T√¨m th·∫•y ng√†y h·ªçc ƒë·∫ßu ti√™n
        const firstLessonDate = currentDate.toLocaleDateString('vi-VN');
        return {
          isValid: true,
          isWarning: true,
          message: `Ng√†y b·∫Øt ƒë·∫ßu (${dayNames[startDayOfWeek]}) kh√¥ng tr√πng v·ªõi l·ªãch h·ªçc. Bu·ªïi h·ªçc ƒë·∫ßu ti√™n s·∫Ω di·ªÖn ra v√†o ${dayNames[dayOfWeek]} (${firstLessonDate}).`
        };
      }
      currentDate.setDate(currentDate.getDate() + 1);
      daysToFirstLesson++;
    }

    // N·∫øu kh√¥ng t√¨m th·∫•y ng√†y h·ªçc n√†o trong 1 tu·∫ßn ‚Üí L·ªói
    return {
      isValid: false,
      message: `Kh√¥ng th·ªÉ x√°c ƒë·ªãnh bu·ªïi h·ªçc ƒë·∫ßu ti√™n. Vui l√≤ng ki·ªÉm tra l·∫°i l·ªãch h·ªçc ƒë√£ ch·ªçn.`
    };
  };

  // T·ª± t√≠nh ng√†y k·∫øt th√∫c d·ª± ki·∫øn d·ª±a v√†o s·ªë b√†i h·ªçc v√† l·ªãch h·ªçc trong tu·∫ßn
  const calculateAutoEndDate = (startDateStr, selectedDays, templateObj) => {
    if (!startDateStr || !selectedDays || selectedDays.length === 0) return '';

    // Validate tr∆∞·ªõc khi t√≠nh to√°n ƒë·ªÉ tr√°nh infinite loop
    const validation = validateStartDateWithScheduleDays(startDateStr, selectedDays);
    if (!validation.isValid) {
      console.warn('Start date validation failed:', validation.message);
      return '';
    }

    try {
      // L·∫•y s·ªë bu·ªïi h·ªçc t·ª´ template
      const lessonsCount = (templateObj?.lessons?.length || 0) > 0
        ? templateObj.lessons.length
        : (templateObj?.totalWeeks || 0) * selectedDays.length || 16; // Default 16 bu·ªïi

      if (!lessonsCount) return '';

      const start = new Date(startDateStr);
      let currentDate = new Date(start);
      let scheduledLessons = 0;

      // Mapping ng√†y trong tu·∫ßn: 0=CN, 1=T2, 2=T3, 3=T4, 4=T5, 5=T6, 6=T7
      const dayMapping = {
        'monday': 1, 'tuesday': 2, 'wednesday': 3,
        'thursday': 4, 'friday': 5, 'saturday': 6, 'sunday': 0
      };
      const targetDays = selectedDays.map(day => dayMapping[day]).filter(d => d !== undefined);

      // Th√™m safety check ƒë·ªÉ tr√°nh infinite loop
      let maxIterations = 365; // T·ªëi ƒëa 1 nƒÉm
      let iterations = 0;

      // T√¨m ng√†y k·∫øt th√∫c b·∫±ng c√°ch ƒë·∫øm c√°c bu·ªïi h·ªçc
      while (scheduledLessons < lessonsCount && iterations < maxIterations) {
        const dayOfWeek = currentDate.getDay();
        if (targetDays.includes(dayOfWeek)) {
          scheduledLessons++;
        }
        if (scheduledLessons < lessonsCount) {
          currentDate.setDate(currentDate.getDate() + 1);
        }
        iterations++;
      }

      if (iterations >= maxIterations) {
        console.warn('Max iterations reached in calculateAutoEndDate');
        return '';
      }

      const yyyy = currentDate.getFullYear();
      const mm = String(currentDate.getMonth() + 1).padStart(2, '0');
      const dd = String(currentDate.getDate()).padStart(2, '0');
      return `${yyyy}-${mm}-${dd}`;
    } catch (e) {
      console.warn('Error calculating end date:', e);
      return '';
    }
  };

  // State ƒë·ªÉ l∆∞u validation message v√† type
  const [scheduleValidation, setScheduleValidation] = useState({ message: '', type: '' });

  // Re-calc endDate khi startDate ho·∫∑c ng√†y trong tu·∫ßn thay ƒë·ªïi
  useEffect(() => {
    if (!formData.startDate) return;

    // Ki·ªÉm tra validation tr∆∞·ªõc
    const validation = validateStartDateWithScheduleDays(formData.startDate, formData.schedule.days);
    if (!validation.isValid) {
      setScheduleValidation({ message: validation.message, type: 'error' });
      return;
    } else if (validation.isWarning) {
      setScheduleValidation({ message: validation.message, type: 'warning' });
    } else {
      setScheduleValidation({ message: '', type: '' });
    }

    const autoEnd = calculateAutoEndDate(formData.startDate, formData.schedule.days, template);
    if (autoEnd && autoEnd !== formData.endDate) {
      setFormData(prev => ({ ...prev, endDate: autoEnd }));
    }
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [formData.startDate, formData.schedule.days, template?.totalWeeks, template?.lessons?.length]);

  // Handle schedule change
  const handleScheduleChange = (scheduleItems) => {
    setState(prev => ({ ...prev, schedule: scheduleItems, scheduleAutoGenerated: false }));
  };

  // Handle schedule validation
  const handleScheduleValidate = (validationResult) => {
    setState(prev => ({ ...prev, scheduleValidation: validationResult }));
  };

  // Navigation between steps
  const goToStep = (step) => {
    console.log('üîÑ [DEBUG] goToStep called:', step);
    setState(prev => ({ ...prev, activeStep: step }));

    // Trigger immediate teacher loading when going to step 3
    if (step === 3 && visible) {
      console.log('üîÑ [DEBUG] Triggering immediate teacher load for step 3');
      setTimeout(() => {
        loadAvailableTeachers();
      }, 100); // Small delay to ensure state is updated
    }
  };

  // Debounced conflict check
  const debouncedConflictCheck = useCallback(
    debounce((data) => {
      checkScheduleConflicts(data);
    }, 1000),
    []
  );

  // Ch·ªâ t·∫£i ph√≤ng khi m·ªü modal; gi√°o vi√™n s·∫Ω t·∫£i sau khi c√≥ ƒë·ªß l·ªãch + ng√†y
  useEffect(() => {
    if (visible) {
      loadRooms();
    }
  }, [visible]);

  // Auto-conflict check when relevant fields change
  useEffect(() => {
    const hasSchedule = formData.schedule?.days?.length > 0 && formData.startDate && formData.endDate;
    const hasResource = Boolean(formData.teacherId) || Boolean(formData.roomId);

    if (hasSchedule && hasResource) {
      debouncedConflictCheck({
        // Only send identifiers that are available to avoid nulls
        ...(formData.roomId ? { roomId: formData.roomId } : {}),
        ...(formData.teacherId ? { teacherId: formData.teacherId } : {}),
        schedule: JSON.stringify(formData.schedule),
        startDate: formData.startDate,
        endDate: formData.endDate
      });
    } else if (!hasSchedule) {
      // Reset conflicts if schedule becomes incomplete
      setState(prev => ({ ...prev, conflicts: [] }));
    }
  }, [formData.roomId, formData.teacherId, formData.schedule, formData.startDate, formData.endDate]);

  // Ki·ªÉm tra ƒëi·ªÅu ki·ªán ƒë·ªß ƒë·ªÉ sinh/l·ªçc l·ªãch ‚Äî khai b√°o s·ªõm ƒë·ªÉ tr√°nh TDZ
  const isScheduleReady = useCallback(() => {
    const ready = (
      formData.startDate &&
      formData.endDate &&
      formData.schedule?.days?.length > 0 &&
      formData.schedule?.startTime &&
      formData.schedule?.endTime
    );
    console.log('üîç [DEBUG] isScheduleReady check:', {
      startDate: formData.startDate,
      endDate: formData.endDate,
      days: formData.schedule?.days,
      startTime: formData.schedule?.startTime,
      endTime: formData.schedule?.endTime,
      result: ready
    });
    return ready;
  }, [formData.startDate, formData.endDate, formData.schedule]);

  // T·∫°o danh s√°ch ti·∫øt h·ªçc t·ª± ƒë·ªông d·ª±a tr√™n l·ªãch tu·∫ßn ·ªü b∆∞·ªõc 1
  const generateScheduleFromWeekly = useCallback(() => {
    if (!isScheduleReady()) return [];

    const dayKeyToWeekday = {
      sunday: 0,
      monday: 1,
      tuesday: 2,
      wednesday: 3,
      thursday: 4,
      friday: 5,
      saturday: 6
    };

    const allowedWeekdays = new Set(
      (formData.schedule.days || []).map(d => dayKeyToWeekday[d]).filter(v => v !== undefined)
    );

    const start = new Date(formData.startDate);
    const end = new Date(formData.endDate);
    const msPerDay = 24 * 60 * 60 * 1000;
    const lessons = Array.isArray(template?.lessons) ? template.lessons : [];
    const sessionsPerWeek = Math.max(1, (formData.schedule.days || []).length);
    const fallbackCount = (template?.totalWeeks || 0) * sessionsPerWeek;
    const totalNeeded = lessons.length > 0 ? lessons.length : (template?.lessonCount || fallbackCount || 0);

    const items = [];
    let idx = 0;
    for (let ts = start.getTime(); ts <= end.getTime(); ts += msPerDay) {
      if (totalNeeded && idx >= totalNeeded) break;
      const cur = new Date(ts);
      const weekday = cur.getDay();
      if (!allowedWeekdays.has(weekday)) continue;

      const iso = `${cur.getFullYear()}-${String(cur.getMonth() + 1).padStart(2, '0')}-${String(cur.getDate()).padStart(2, '0')}`;
      const weekIndex = Math.floor((ts - start.getTime()) / (7 * msPerDay)) + 1;
      const lessonName = lessons[idx]?.topicName || `Bu·ªïi ${idx + 1}`;

      items.push({
        id: `auto-${idx}`,
        lessonId: lessons[idx]?.id || null,
        lessonName,
        week: weekIndex,
        date: iso,
        startTime: formData.schedule.startTime,
        endTime: formData.schedule.endTime,
        room: null,
        status: 'draft',
        duration: formData.schedule.duration || 120
      });

      idx += 1;
    }

    return items;
  }, [formData.schedule, formData.startDate, formData.endDate, template]);

  // T·ª± ƒë·ªông ƒë·ªï ti·∫øt h·ªçc sang b∆∞·ªõc 2 khi ng∆∞·ªùi d√πng ƒë√£ ch·ªçn l·ªãch ·ªü b∆∞·ªõc 1
  useEffect(() => {
    if (!visible) return;
    if (!isScheduleReady()) return;
    // Ch·ªâ auto-gen n·∫øu ch∆∞a c√≥ d·ªØ li·ªáu ho·∫∑c d·ªØ li·ªáu n√†y do auto-gen tr∆∞·ªõc ƒë√≥
    if (state.activeStep <= 2 && (state.schedule.length === 0 || state.scheduleAutoGenerated)) {
      const items = generateScheduleFromWeekly();
      if (items.length > 0) {
        setState(prev => ({ ...prev, schedule: items, scheduleAutoGenerated: true }));
      }
    }
  }, [visible, state.activeStep, isScheduleReady, generateScheduleFromWeekly, state.schedule.length, state.scheduleAutoGenerated]);


  // T·∫£i gi√°o vi√™n kh·∫£ d·ª•ng theo l·ªãch v√† m√¥n v·ªõi caching
  const loadAvailableTeachers = async () => {
    console.log('üîç [DEBUG] loadAvailableTeachers called');
    console.log('üîç [DEBUG] isScheduleReady():', isScheduleReady());
    console.log('üîç [DEBUG] formData:', {
      startDate: formData.startDate,
      endDate: formData.endDate,
      schedule: formData.schedule,
      educationLevel: formData.educationLevel
    });
    console.log('üîç [DEBUG] template:', template);

    if (!isScheduleReady()) {
      console.log('‚ùå [DEBUG] Schedule not ready, clearing teachers');
      setState(prev => ({ ...prev, teachers: [] }));
      setFormData(prev => ({ ...prev, teacherId: null }));
      return;
    }

    // T·∫°o cache key ƒë·ªÉ tr√°nh g·ªçi API tr√πng l·∫∑p
    const cacheKey = `${template?.subject}-${formData.educationLevel}-${formData.startDate}-${formData.endDate}-${JSON.stringify(formData.schedule)}`;
    if (state.lastTeacherQuery === cacheKey) {
      return; // ƒê√£ query v·ªõi c√πng tham s·ªë r·ªìi, b·ªè qua
    }

    setState(prev => ({ 
      ...prev, 
      loading: { ...prev.loading, teachers: true },
      lastTeacherQuery: cacheKey 
    }));
    try {
      // Chu·∫©n h√≥a subject ‚Üí l·∫•y t·ª´ kh√≥a ch√≠nh ƒë·ªÉ kh·ªõp v·ªõi department c·ªßa gi√°o vi√™n trong BE
      const normalizeSubject = (raw) => {
        if (!raw) return '';
    const s = String(raw).toLowerCase();
        const keywords = ['to√°n','v·∫≠t l√Ω','v·∫≠t l√≠','h√≥a','ho√°','ng·ªØ vƒÉn','ti·∫øng anh','sinh h·ªçc'];
    const found = keywords.find(k => s.includes(k));
        if (found) return found;
        // fallback: l·∫•y ph·∫ßn tr∆∞·ªõc d·∫•u ' - '
    return s.split(' - ')[0];
      };

      // Chu·∫©n h√≥a days ‚Üí MON/TUE/WED... ƒë·ªÉ BE parse ƒë√∫ng
      const mapDaysForBE = (daysArr) => {
        const map = {
          monday: 'MON', tuesday: 'TUE', wednesday: 'WED', thursday: 'THU', friday: 'FRI', saturday: 'SAT', sunday: 'SUN',
          monday_vi: 'THU 2', tuesday_vi: 'THU 3', wednesday_vi: 'THU 4', thursday_vi: 'THU 5', friday_vi: 'THU 6', saturday_vi: 'THU 7', sunday_vi: 'CHU NHAT'
        };
        return (daysArr || []).map(d => {
          const key = String(d).toLowerCase();
          return map[key] || map[`${key}_vi`] || 'MON';
        });
      };

      const normalizedSchedule = {
        ...formData.schedule,
        days: mapDaysForBE(formData.schedule?.days)
      };

      const payload = {
        subject: normalizeSubject(template.subject || template?.name || ''),
        educationLevel: formData.educationLevel || template?.grade || template?.educationLevel || '',
        schedule: JSON.stringify(normalizedSchedule),
        startDate: formData.startDate,
        endDate: formData.endDate
      };

      console.log('üì§ [DEBUG] Sending teacher filter request:');
      console.log('üì§ [DEBUG] Raw template subject:', template.subject || template?.name);
      console.log('üì§ [DEBUG] Normalized subject:', payload.subject);
      console.log('üì§ [DEBUG] Education level:', payload.educationLevel);
      console.log('üì§ [DEBUG] Schedule JSON:', payload.schedule);
      console.log('üì§ [DEBUG] Date range:', payload.startDate, 'to', payload.endDate);
      console.log('üì§ [DEBUG] Full payload:', payload);

      const response = await classManagementService.getAvailableTeachers(payload);
      const teachersData = response.data?.data || response.data || [];

      console.log('üì• [DEBUG] Teacher filter response:');
      console.log('üì• [DEBUG] Raw response:', response);
      console.log('üì• [DEBUG] Teachers data:', teachersData);
      console.log('üì• [DEBUG] Teachers count:', Array.isArray(teachersData) ? teachersData.length : 'Not array');

      setState(prev => ({
        ...prev,
        teachers: Array.isArray(teachersData) ? teachersData : [],
        loading: { ...prev.loading, teachers: false }
      }));
      // N·∫øu gi√°o vi√™n ƒë√£ ch·ªçn kh√¥ng c√≤n trong danh s√°ch m·ªõi ‚Üí reset
      if (formData.teacherId && !teachersData.find?.(t => t.id === formData.teacherId)) {
        setFormData(prev => ({ ...prev, teacherId: null }));
      }
    } catch (error) {
      console.error('‚ùå [DEBUG] Error loading available teachers:', error);
      console.error('‚ùå [DEBUG] Error details:', {
        message: error.message,
        response: error.response?.data,
        status: error.response?.status
      });
      setState(prev => ({
        ...prev,
        teachers: [],
        errors: { ...prev.errors, teachers: error.message },
        loading: { ...prev.loading, teachers: false }
      }));
    }
  };

  // Debounced teacher loading - gi·∫£m delay ƒë·ªÉ responsive h∆°n
  const debouncedTeacherLoad = useCallback(
    debounce(() => {
      if (!visible) return;
      if (state.activeStep === 3 || state.activeStep === 1) {
        console.log('üîÑ [DEBUG] Debounced teacher load triggered');
        loadAvailableTeachers();
      }
    }, 500), // Gi·∫£m delay xu·ªëng 500ms ƒë·ªÉ responsive h∆°n
    []
  );

  useEffect(() => {
    debouncedTeacherLoad();
  }, [formData.startDate, formData.endDate, JSON.stringify(formData.schedule), formData.educationLevel, state.activeStep, template?.subject, visible]);

  // Load rooms
  const loadRooms = async () => {
    setState(prev => ({ ...prev, loading: { ...prev.loading, rooms: true } }));
    
    try {
      const response = await classManagementService.getAllRooms();
      const roomsData = response.data?.data || response.data || [];
      setState(prev => ({
        ...prev,
        rooms: Array.isArray(roomsData) ? roomsData : [],
        loading: { ...prev.loading, rooms: false }
      }));
    } catch (error) {
      console.error('Error loading rooms:', error);
      setState(prev => ({
        ...prev,
        rooms: [],
        errors: { ...prev.errors, rooms: error.message },
        loading: { ...prev.loading, rooms: false }
      }));
    }
  };

  // Check schedule conflicts
  const checkScheduleConflicts = async (scheduleData) => {
    setState(prev => ({ ...prev, loading: { ...prev.loading, conflicts: true } }));
    
    try {
      const response = await classManagementService.checkScheduleConflicts(scheduleData);
      const conflicts = response?.data?.data ?? response?.data ?? [];
      setState(prev => ({
        ...prev,
        conflicts: Array.isArray(conflicts) ? conflicts : [],
        loading: { ...prev.loading, conflicts: false }
      }));
    } catch (error) {
      console.error('Error checking conflicts:', error);
      setState(prev => ({
        ...prev,
        conflicts: [],
        loading: { ...prev.loading, conflicts: false }
      }));
    }
  };

  // Handle form field changes
  const handleFieldChange = (field, value) => {
    if (field.includes('.')) {
      const [parent, child] = field.split('.');
      setFormData(prev => ({
        ...prev,
        [parent]: { ...prev[parent], [child]: value },
        validation: { ...prev.validation, [field]: null }
      }));
    } else {
      setFormData(prev => ({
        ...prev,
        [field]: value,
        validation: { ...prev.validation, [field]: null }
      }));
    }
  };

  // Handle schedule days change
  const handleScheduleDaysChange = (day) => {
    const newDays = formData.schedule.days.includes(day)
      ? formData.schedule.days.filter(d => d !== day)
      : [...formData.schedule.days, day];
    
    setFormData(prev => ({
      ...prev,
      schedule: { ...prev.schedule, days: newDays },
      validation: { ...prev.validation, scheduleDays: null }
    }));
  };

  // Handle form submission
  const handleSubmit = async () => {
    console.log('üîç [CREATE-CLASS] Starting class creation process');
    console.log('üîç [CREATE-CLASS] Template:', template);
    console.log('üîç [CREATE-CLASS] Form data:', formData);

    // Validate form
    const validation = validateClassForm(formData);
    if (Object.keys(validation).length > 0) {
      console.log('‚ùå [CREATE-CLASS] Validation failed:', validation);
      setFormData(prev => ({ ...prev, validation }));
      showNotification('Vui l√≤ng ki·ªÉm tra l·∫°i th√¥ng tin', 'warning');
      return;
    }

    // Check conflicts and confirm if needed
    if (state.conflicts.length > 0) {
      console.log('‚ö†Ô∏è [CREATE-CLASS] Schedule conflicts detected:', state.conflicts);
      const confirmed = await showConfirmDialog(
        'Ph√°t hi·ªán xung ƒë·ªôt l·ªãch h·ªçc',
        `C√≥ ${state.conflicts.length} xung ƒë·ªôt l·ªãch ƒë∆∞·ª£c ph√°t hi·ªán. B·∫°n c√≥ mu·ªën ti·∫øp t·ª•c t·∫°o l·ªõp h·ªçc?`
      );
      if (!confirmed) {
        console.log('‚ùå [CREATE-CLASS] User cancelled due to conflicts');
        return;
      }
    }

    setState(prev => ({ ...prev, loading: { ...prev.loading, submit: true } }));

    try {
      const classData = {
        courseTemplateId: template.id,
        className: formData.className,
        description: formData.description,
        introVideoUrl: formData.introVideoUrl || null, // Th√™m video URL
        teacherId: formData.teacherId,
        roomId: formData.roomId,
        startDate: formData.startDate,
        // endDate c√≥ th·ªÉ ƒë·ªÉ tr·ªëng; BE s·∫Ω t·ª± t√≠nh d·ª±a v√†o lessons & l·ªãch h·ªçc
        endDate: formData.endDate || null,
        schedule: JSON.stringify(formData.schedule),
        maxStudents: formData.maxStudents,
        settings: formData.settings,
        createdBy: getCurrentUserId()
      };

      console.log('üì§ [CREATE-CLASS] Sending class data to backend:', classData);
      console.log('üì§ [CREATE-CLASS] API endpoint: createClass');

      const response = await classManagementService.createClass(classData);

      console.log('‚úÖ [CREATE-CLASS] Backend response:', response);
      console.log('‚úÖ [CREATE-CLASS] Created class data:', response.data);

      // Check if classroom was created after a delay
      setTimeout(async () => {
        console.log('üîç [CREATE-CLASS] Checking if classroom was created...');
        try {
          const classroom = await classManagementService.checkClassroomForClass(formData.className);
          if (classroom) {
            console.log('‚úÖ [CREATE-CLASS] Classroom sync successful:', classroom);
          } else {
            console.log('‚ö†Ô∏è [CREATE-CLASS] Classroom not found - sync may have failed');
          }
        } catch (error) {
          console.error('‚ùå [CREATE-CLASS] Error checking classroom:', error);
        }
      }, 3000);

      showNotification(`T·∫°o l·ªõp h·ªçc "${formData.className}" th√†nh c√¥ng!`, 'success');

      // Reset form and close modal
      handleReset();
      onSuccess(response.data);

    } catch (error) {
      console.error('‚ùå [CREATE-CLASS] Error creating class:', error);
      console.error('‚ùå [CREATE-CLASS] Error response:', error.response);
      console.error('‚ùå [CREATE-CLASS] Error message:', error.message);
      showNotification('L·ªói t·∫°o l·ªõp h·ªçc: ' + (error.response?.data?.message || error.message), 'error');
    } finally {
      setState(prev => ({ ...prev, loading: { ...prev.loading, submit: false } }));
      console.log('üîÑ [CREATE-CLASS] Class creation process completed');
    }
  };

  // Reset form
  const handleReset = () => {
    setFormData({
      className: '',
      description: '',
      introVideoUrl: '', // Reset video URL
      teacherId: null,
      roomId: null,
      startDate: '',
      endDate: '',
      schedule: {
        days: [],
        startTime: '',
        endTime: '',
        duration: 120
      },
      maxStudents: 30,
      settings: {
        allowLateEnrollment: true,
        requireApproval: false,
        isPublic: true
      },
      validation: {}
    });
    setState(prev => ({ ...prev, conflicts: [] }));
  };

  // Handle cancel
  const handleCancel = () => {
    handleReset();
    onCancel();
  };

  if (!visible || !template) return null;

  const dayNames = [
    { key: 'monday', label: 'Th·ª© 2' },
    { key: 'tuesday', label: 'Th·ª© 3' },
    { key: 'wednesday', label: 'Th·ª© 4' },
    { key: 'thursday', label: 'Th·ª© 5' },
    { key: 'friday', label: 'Th·ª© 6' },
    { key: 'saturday', label: 'Th·ª© 7' },
    { key: 'sunday', label: 'Ch·ªß nh·∫≠t' }
  ];

  return (
    <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
      <div className="bg-white rounded-lg shadow-xl w-full max-w-6xl max-h-[95vh] overflow-y-auto">
        <div className="p-6">
          {/* Header */}
          <div className="flex items-center justify-between mb-6">
            <div>
              <h3 className="text-xl font-semibold text-gray-900 flex items-center">
                <span className="text-2xl mr-3">üè´</span>
                T·∫°o l·ªõp h·ªçc t·ª´: {template.name}
              </h3>
              <p className="text-sm text-gray-600 mt-1">
                {template.description}
              </p>
            </div>
            <button
              onClick={handleCancel}
              className="text-gray-400 hover:text-gray-600 text-2xl font-bold"
            >
              √ó
            </button>
          </div>

          {/* Step Navigation */}
          <div className="border-b border-gray-200 mb-6">
            <nav className="flex space-x-8">
              {[
                { step: 1, label: 'üìã Th√¥ng tin c∆° b·∫£n', desc: 'T√™n l·ªõp, gi√°o vi√™n' },
                { step: 2, label: 'üìÖ L·ªãch h·ªçc & Ph√≤ng', desc: 'Th·ªùi gian, ph√≤ng h·ªçc' },
                { step: 3, label: 'üîç Xem tr∆∞·ªõc & T·∫°o', desc: 'Ki·ªÉm tra v√† ho√†n t·∫•t' }
              ].map(item => (
                <button
                  key={item.step}
                  onClick={() => goToStep(item.step)}
                  className={`py-4 px-2 border-b-2 font-medium text-sm transition-colors ${
                    state.activeStep === item.step
                      ? 'border-blue-500 text-blue-600'
                      : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'
                  }`}
                >
                  <div>{item.label}</div>
                  <div className="text-xs opacity-75">{item.desc}</div>
                </button>
              ))}
            </nav>
          </div>

          {/* Global loading banner */}
          {(state.loading.conflicts || state.loading.teachers || state.loading.rooms || state.loading.submit) && (
            <div className="mb-4 p-2 bg-blue-50 border border-blue-200 rounded animate-pulse text-sm text-blue-800 flex items-center">
              <span className="animate-spin inline-block mr-2">‚ü≥</span>
              <span>
                {[
                  state.loading.conflicts ? 'ƒêang ki·ªÉm tra xung ƒë·ªôt l·ªãch' : null,
                  state.loading.teachers ? 'ƒêang l·ªçc gi√°o vi√™n ph√π h·ª£p' : null,
                  state.loading.rooms ? 'ƒêang t·∫£i danh s√°ch ph√≤ng' : null,
                  state.loading.submit ? 'ƒêang t·∫°o l·ªõp h·ªçc...' : null,
                ].filter(Boolean).join(' ‚Ä¢ ')}
              </span>
            </div>
          )}

          {/* Schedule Conflicts Alert */}
          {state.conflicts.length > 0 && (
            <div className="mb-6 p-4 bg-red-50 border border-red-200 rounded-lg">
              <div className="flex items-center mb-2">
                <span className="text-red-600 mr-2 text-xl">‚ö†Ô∏è</span>
                <h4 className="text-red-800 font-medium">
                  Ph√°t hi·ªán {state.conflicts.length} xung ƒë·ªôt l·ªãch h·ªçc!
                </h4>
              </div>
              <div className="space-y-1">
                {state.conflicts.map((conflict, index) => (
                  <div key={index} className="flex items-start text-sm text-red-700">
                    <span className="mr-2 mt-0.5">‚Ä¢</span>
                    <span>{conflict.details || conflict.message || 'Xung ƒë·ªôt l·ªãch h·ªçc'}</span>
                  </div>
                ))}
              </div>
            </div>
          )}

          {/* Step Content */}
          {state.activeStep === 1 && (
            <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
              {/* Main Form */}
              <div className="lg:col-span-2 space-y-6">
              {/* Basic Information */}
              <div className="bg-gray-50 p-4 rounded-lg">
                <h4 className="font-medium text-gray-900 mb-4 flex items-center">
                  <span className="mr-2">üìù</span>
                  Th√¥ng tin c∆° b·∫£n
                  {state.loading.submit && (
                    <span className="ml-2 text-sm text-blue-600">
                      <span className="animate-spin inline-block">‚ü≥</span> ƒêang x·ª≠ l√Ω...
                    </span>
                  )}
                </h4>
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-2">
                      T√™n l·ªõp h·ªçc <span className="text-red-500">*</span>
                    </label>
                    <input
                      type="text"
                      value={formData.className}
                      onChange={(e) => handleFieldChange('className', e.target.value)}
                      className={`w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 ${
                        formData.validation.className ? 'border-red-300 bg-red-50' : 'border-gray-300'
                      }`}
                      placeholder="V√≠ d·ª•: Java-Spring-2024-K1"
                    />
                    {formData.validation.className && (
                      <p className="mt-1 text-sm text-red-600">{formData.validation.className}</p>
                    )}
                  </div>

                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-2">S·ªë h·ªçc vi√™n t·ªëi ƒëa</label>
                    <input
                      type="number"
                      min="1"
                      max="100"
                      value={formData.maxStudents}
                      onChange={(e) => handleFieldChange('maxStudents', parseInt(e.target.value) || 30)}
                      className={`w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 ${
                        formData.validation.maxStudents ? 'border-red-300 bg-red-50' : 'border-gray-300'
                      }`}
                    />
                    {formData.validation.maxStudents && (
                      <p className="mt-1 text-sm text-red-600">{formData.validation.maxStudents}</p>
                    )}
                  </div>
                </div>

                <div className="mt-4">
                  <label className="block text-sm font-medium text-gray-700 mb-2">M√¥ t·∫£ l·ªõp h·ªçc</label>
                  <textarea
                    rows={3}
                    value={formData.description}
                    onChange={(e) => handleFieldChange('description', e.target.value)}
                    className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                    placeholder="M√¥ t·∫£ v·ªÅ l·ªõp h·ªçc, y√™u c·∫ßu ƒë·∫ßu v√†o, m·ª•c ti√™u..."
                  />
                </div>

                {/* Video Gi·ªõi thi·ªáu */}
                <div className="mt-4">
                  <label className="block text-sm font-medium text-gray-700 mb-2">
                    üé• Video Gi·ªõi thi·ªáu (T√πy ch·ªçn)
                  </label>
                  <input
                    type="url"
                    value={formData.introVideoUrl}
                    onChange={(e) => handleFieldChange('introVideoUrl', e.target.value)}
                    className={`w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 ${
                      formData.validation.introVideoUrl ? 'border-red-300 bg-red-50' : 'border-gray-300'
                    }`}
                    placeholder="https://www.youtube.com/watch?v=... ho·∫∑c https://vimeo.com/..."
                  />
                  {formData.validation.introVideoUrl && (
                    <p className="mt-1 text-sm text-red-600">{formData.validation.introVideoUrl}</p>
                  )}
                  <p className="mt-1 text-xs text-gray-500">
                    H·ªó tr·ª£: YouTube, Vimeo, Zoom, Google Meet. Video n√†y s·∫Ω hi·ªÉn th·ªã trong trang kh√≥a h·ªçc c√¥ng khai.
                  </p>
                </div>
              </div>

              {/* Education Level (Kh·ªëi h·ªçc) */}
              <div className="bg-gray-50 p-4 rounded-lg">
                <h4 className="font-medium text-gray-900 mb-4 flex items-center">
                  <span className="mr-2">üè∑Ô∏è</span>
                  Kh·ªëi h·ªçc
                  {(state.loading.teachers) && (
                    <span className="ml-2 text-sm text-blue-600">
                      <span className="animate-spin inline-block">‚ü≥</span> ƒêang l·ªçc gi√°o vi√™n...
                    </span>
                  )}
                </h4>
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-2">Ch·ªçn kh·ªëi</label>
                    <select
                      value={formData.educationLevel || ''}
                      onChange={(e) => handleFieldChange('educationLevel', e.target.value)}
                      className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                    >
                      <option value="">Kh√¥ng x√°c ƒë·ªãnh</option>
                      <option value="10">Kh·ªëi 10</option>
                      <option value="11">Kh·ªëi 11</option>
                      <option value="12">Kh·ªëi 12</option>
                    </select>
                    <p className="text-xs text-gray-500 mt-2">D√πng ƒë·ªÉ l·ªçc gi√°o vi√™n ph√π h·ª£p ·ªü b∆∞·ªõc sau.</p>
                  </div>
                </div>
              </div>

              {/* Schedule Configuration */}
              <div className="bg-gray-50 p-4 rounded-lg">
                <h4 className="font-medium text-gray-900 mb-4 flex items-center">
                  <span className="mr-2">üìÖ</span>
                  L·ªãch h·ªçc
                  {state.loading.conflicts && (
                    <span className="ml-2 text-sm text-blue-600">
                      <span className="animate-spin inline-block">‚ü≥</span> ƒêang ki·ªÉm tra xung ƒë·ªôt...
                    </span>
                  )}
                </h4>
                
                {/* Date Range */}
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-2">
                      Ng√†y b·∫Øt ƒë·∫ßu <span className="text-red-500">*</span>
                    </label>
                    <input
                      type="date"
                      value={formData.startDate}
                      onChange={(e) => handleFieldChange('startDate', e.target.value)}
                      className={`w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 ${
                        formData.validation.startDate ? 'border-red-300 bg-red-50' : 'border-gray-300'
                      }`}
                    />
                    {formData.validation.startDate && (
                      <p className="mt-1 text-sm text-red-600">{formData.validation.startDate}</p>
                    )}
                  </div>

                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-2">
                      Ng√†y k·∫øt th√∫c <span className="text-gray-400"></span>
                    </label>
                    <input
                      type="date"
                      value={formData.endDate}
                      readOnly
                      className="w-full px-3 py-2 border border-gray-300 rounded-md bg-gray-100 text-gray-600 cursor-not-allowed"
                      title="Ng√†y k·∫øt th√∫c ƒë∆∞·ª£c t·ª± ƒë·ªông t√≠nh to√°n d·ª±a tr√™n ng√†y b·∫Øt ƒë·∫ßu, s·ªë bu·ªïi h·ªçc v√† l·ªãch h·ªçc trong tu·∫ßn"
                    />
                    <p className="mt-1 text-xs text-gray-500">
                      {/* üìÖ T·ª± ƒë·ªông t√≠nh d·ª±a tr√™n: ng√†y b·∫Øt ƒë·∫ßu + s·ªë bu·ªïi h·ªçc + l·ªãch tu·∫ßn */}
                    </p>
                  </div>
                </div>

                {/* Days of Week */}
                <div className="mb-4">
                  <label className="block text-sm font-medium text-gray-700 mb-2">
                    Ng√†y h·ªçc trong tu·∫ßn <span className="text-red-500">*</span>
                  </label>
                  <div className="grid grid-cols-3 md:grid-cols-7 gap-2">
                    {dayNames.map(day => (
                      <label key={day.key} className="flex items-center">
                        <input
                          type="checkbox"
                          checked={formData.schedule.days.includes(day.key)}
                          onChange={() => handleScheduleDaysChange(day.key)}
                          className="mr-2 rounded border-gray-300 text-blue-600 focus:ring-blue-500"
                        />
                        <span className="text-sm">{day.label}</span>
                      </label>
                    ))}
                  </div>
                  {formData.validation.scheduleDays && (
                    <p className="mt-1 text-sm text-red-600">{formData.validation.scheduleDays}</p>
                  )}
                  {scheduleValidation.message && (
                    <div className={`mt-2 p-3 rounded-md ${
                      scheduleValidation.type === 'error'
                        ? 'bg-red-50 border border-red-200'
                        : 'bg-yellow-50 border border-yellow-200'
                    }`}>
                      <div className="flex">
                        <div className="flex-shrink-0">
                          <span className={scheduleValidation.type === 'error' ? 'text-red-400' : 'text-yellow-400'}>
                            {scheduleValidation.type === 'error' ? '‚ùå' : '‚ö†Ô∏è'}
                          </span>
                        </div>
                        <div className="ml-3">
                          <p className={`text-sm ${
                            scheduleValidation.type === 'error' ? 'text-red-800' : 'text-yellow-800'
                          }`}>
                            {scheduleValidation.message}
                          </p>
                        </div>
                      </div>
                    </div>
                  )}
                </div>

                {/* Time Range */}
                  <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-2">
                      Gi·ªù b·∫Øt ƒë·∫ßu <span className="text-red-500">*</span>
                    </label>
                      <select
                        value={formData.schedule.startTime}
                        onChange={(e) => {
                          const start = e.target.value;
                          // auto set endTime = start + 120 minutes
                          const [h, m] = start.split(':').map(Number);
                          const d = new Date(0, 0, 0, h, m + 120, 0);
                          const end = `${String(d.getHours()).padStart(2, '0')}:${String(d.getMinutes()).padStart(2, '0')}`;
                          handleFieldChange('schedule.startTime', start);
                          handleFieldChange('schedule.endTime', end);
                        }}
                        className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                      >
                        {['07:30','09:30','13:30','15:30','18:00','20:00'].map(t => (
                          <option key={t} value={t}>{t}</option>
                        ))}
                      </select>
                  </div>

                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-2">
                        Gi·ªù k·∫øt th√∫c
                      </label>
                      <input
                        type="time"
                        value={formData.schedule.endTime}
                        readOnly
                        className="w-full px-3 py-2 border border-gray-300 rounded-md bg-gray-100 text-gray-600"
                      />
                    </div>

                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-2">Th·ªùi l∆∞·ª£ng (ph√∫t)</label>
                      <input
                        type="number"
                        min="120"
                        max="120"
                        step="0"
                        value={120}
                        readOnly
                        className="w-full px-3 py-2 border border-gray-300 rounded-md bg-gray-100 text-gray-600"
                      />
                  </div>
                </div>
                {formData.validation.scheduleTime && (
                  <p className="mt-1 text-sm text-red-600">{formData.validation.scheduleTime}</p>
                )}
              </div>

              {/* Advanced Settings */}
              <div className="bg-gray-50 p-4 rounded-lg">
                <h4 className="font-medium text-gray-900 mb-4 flex items-center">
                  <span className="mr-2">‚öôÔ∏è</span>
                  C√†i ƒë·∫∑t n√¢ng cao
                </h4>
                <div className="space-y-3">
                {/*   <label className="flex items-center">
                    <input
                      type="checkbox"
                      checked={formData.settings.allowLateEnrollment}
                      onChange={(e) => handleFieldChange('settings.allowLateEnrollment', e.target.checked)}
                      className="mr-3 rounded border-gray-300 text-blue-600 focus:ring-blue-500"
                    />
                    <span className="text-sm">Cho ph√©p ƒëƒÉng k√Ω mu·ªôn</span>
                  </label>

                  <label className="flex items-center">
                    <input
                      type="checkbox"
                      checked={formData.settings.requireApproval}
                      onChange={(e) => handleFieldChange('settings.requireApproval', e.target.checked)}
                      className="mr-3 rounded border-gray-300 text-blue-600 focus:ring-blue-500"
                    />
                    <span className="text-sm">Y√™u c·∫ßu duy·ªát khi ƒëƒÉng k√Ω</span>
                  </label> */}

                  <label className="flex items-center">
                    <input
                      type="checkbox"
                      checked={formData.settings.isPublic}
                      onChange={(e) => handleFieldChange('settings.isPublic', e.target.checked)}
                      className="mr-3 rounded border-gray-300 text-blue-600 focus:ring-blue-500"
                    />
                    <span className="text-sm">C√¥ng khai l·ªõp h·ªçc</span>
                  </label>
                </div>
              </div>
            </div>

            {/* Sidebar - Template Info & Preview */}
            <div className="space-y-6">
              {/* Template Information */}
    {/*           <div className="bg-blue-50 border border-blue-200 rounded-lg p-4">
                <h4 className="font-medium text-blue-900 mb-3 flex items-center">
                  <span className="mr-2">üìö</span>
                  Template: {template.name}
                </h4>
                <div className="space-y-2 text-sm">
                  <div className="flex justify-between">
                    <span className="text-blue-700">T·ªïng s·ªë tu·∫ßn:</span>
                    <span className="font-medium">{template.totalWeeks || 'N/A'}</span>
                  </div>
                  <div className="flex justify-between">
                    <span className="text-blue-700">S·ªë b√†i h·ªçc:</span>
                    <span className="font-medium">{template.lessonCount || 'N/A'}</span>
                  </div>
                  <div className="flex justify-between">
                    <span className="text-blue-700">M√¥n h·ªçc:</span>
                    <span className="font-medium">{template.subject || 'N/A'}</span>
                  </div>
                </div>
              </div> */}

              {/* Schedule Preview */}
              {(formData.schedule.days.length > 0 && formData.schedule.startTime && formData.schedule.endTime) && (
                <div className="bg-green-50 border border-green-200 rounded-lg p-4">
                  <h4 className="font-medium text-green-900 mb-3 flex items-center">
                    <span className="mr-2">üìÖ</span>
                    Xem tr∆∞·ªõc l·ªãch h·ªçc
                  </h4>
                  <div className="text-sm text-green-800">
                    <p className="mb-2">
                      <strong>L·ªãch:</strong> {formatSchedule(formData.schedule)}
                    </p>
                    {formData.startDate && formData.endDate && (
                      <p className="mb-2">
                        <strong>Th·ªùi gian:</strong><br />
                        {formData.startDate} ‚Üí {formData.endDate}
                      </p>
                    )}
                    <p>
                      <strong>Th·ªùi l∆∞·ª£ng m·ªói bu·ªïi:</strong> {formData.schedule.duration} ph√∫t
                    </p>
                  </div>
                </div>
              )}

              {/* Conflict Status */}
              <div className={`border rounded-lg p-4 ${
                state.conflicts.length > 0 ? 'bg-red-50 border-red-200' : 'bg-green-50 border-green-200'
              }`}>
                <h4 className={`font-medium mb-2 flex items-center ${
                  state.conflicts.length > 0 ? 'text-red-900' : 'text-green-900'
                }`}>
                  <span className="mr-2">{state.conflicts.length > 0 ? '‚ö†Ô∏è' : '‚úÖ'}</span>
                  Tr·∫°ng th√°i xung ƒë·ªôt
                </h4>
                <p className={`text-sm ${
                  state.conflicts.length > 0 ? 'text-red-800' : 'text-green-800'
                }`}>
                  {state.loading.conflicts ? 'ƒêang ki·ªÉm tra...' :
                   state.conflicts.length > 0 ? 
                   `${state.conflicts.length} xung ƒë·ªôt ƒë∆∞·ª£c ph√°t hi·ªán` :
                   'Kh√¥ng c√≥ xung ƒë·ªôt l·ªãch h·ªçc'}
                </p>
              </div>
            </div>
          </div>
          )}

          {/* Step 2: Ch·ªçn ph√≤ng cho t·ª´ng ti·∫øt */}
          {state.activeStep === 2 && (
            <div>
              <ScheduleManager
                classData={{
                  id: null, // New class
                  template: template,
                  expectedStudents: formData.maxStudents
                }}
                existingSchedule={state.schedule}
                onScheduleChange={handleScheduleChange}
                onScheduleValidate={handleScheduleValidate}
                mode="create"
                teacherId={formData.teacherId}
                startDate={formData.startDate}
                endDate={formData.endDate}
                weeklySchedule={formData.schedule}
              />
            </div>
          )}

          {/* Step 3: Ch·ªçn gi√°o vi√™n & Review */}
          {state.activeStep === 3 && (
            <div className="space-y-6">
              <h3 className="text-lg font-medium text-gray-900">üîç Xem tr∆∞·ªõc & Ho√†n t·∫•t</h3>
              {state.loading.conflicts && (
                <div className="p-3 rounded bg-blue-50 border border-blue-200 text-blue-800 text-sm">
                  <span className="animate-spin inline-block mr-2">‚ü≥</span>
                  ƒêang ki·ªÉm tra xung ƒë·ªôt l·ªãch...
                </div>
              )}
              {!state.loading.conflicts && state.conflicts.length > 0 && (
                <div className="p-3 rounded bg-red-50 border border-red-200 text-red-800 text-sm">
                  ‚ö†Ô∏è Ph√°t hi·ªán {state.conflicts.length} xung ƒë·ªôt l·ªãch. Vui l√≤ng ƒë·ªïi gi√°o vi√™n, l·ªãch ho·∫∑c ph√≤ng.
                </div>
              )}
              {/* Ch·ªçn gi√°o vi√™n ·ªü b∆∞·ªõc review ƒë·ªÉ ƒë·∫£m b·∫£o sau khi ƒë√£ c·ªë ƒë·ªãnh l·ªãch */}
              <div className="bg-gray-50 p-4 rounded-lg">
                <h4 className="font-medium text-gray-900 mb-4 flex items-center">
                  <span className="mr-2">üë®‚Äçüè´</span>
                  Ch·ªçn gi√°o vi√™n
                  {state.loading.teachers && (
                    <span className="ml-2 text-sm text-blue-600">
                      <span className="animate-spin inline-block">‚ü≥</span> ƒêang l·ªçc...
                    </span>
                  )}
                </h4>
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-2">
                      Gi√°o vi√™n <span className="text-red-500">*</span>
                    </label>
                    <select
                      value={formData.teacherId || ''}
                      onChange={(e) => handleFieldChange('teacherId', parseInt(e.target.value) || null)}
                      className={`w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 ${
                        formData.validation.teacherId ? 'border-red-300 bg-red-50' : 'border-gray-300'
                      }`}
                      disabled={state.loading.teachers || !isScheduleReady()}
                    >
                      <option value="">
                        {!isScheduleReady()
                          ? 'Vui l√≤ng ho√†n t·∫•t l·ªãch + ng√†y ƒë·ªÉ g·ª£i √Ω gi√°o vi√™n'
                          : state.loading.teachers
                            ? 'ƒêang l·ªçc gi√°o vi√™n ph√π h·ª£p...'
                            : (state.teachers.length === 0 ? 'Kh√¥ng c√≥ gi√°o vi√™n ph√π h·ª£p' : 'Ch·ªçn gi√°o vi√™n')}
                      </option>
                      {state.teachers.map(teacher => (
                        <option key={teacher.id} value={teacher.id}>
                          {teacher.fullName || teacher.name} - {teacher.department || 'Ch∆∞a c√≥ chuy√™n m√¥n'}
                        </option>
                      ))}
                    </select>
                    {formData.validation.teacherId && (
                      <p className="mt-1 text-sm text-red-600">{formData.validation.teacherId}</p>
                    )}
                  </div>
                </div>
                <p className="text-xs text-gray-600 mt-2">Danh s√°ch gi√°o vi√™n ƒë√£ ƒë∆∞·ª£c l·ªçc theo m√¥n h·ªçc, kh·ªëi {formData.educationLevel || template?.grade || 'N/A'} v√† l·ªãch, ƒë·ªìng th·ªùi ki·ªÉm tra xung ƒë·ªôt.</p>
              </div>
              
              <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div className="space-y-4">
                  <div className="bg-gray-50 p-4 rounded-lg">
                    <h4 className="font-medium text-gray-900 mb-3">üìã Th√¥ng tin l·ªõp h·ªçc</h4>
                    <div className="space-y-2 text-sm">
                      <div className="flex justify-between">
                        <span className="text-gray-600">T√™n l·ªõp:</span>
                        <span className="font-medium">{formData.className || 'Ch∆∞a nh·∫≠p'}</span>
                      </div>
                       <div className="flex justify-between">
                        <span className="text-gray-600">Gi√°o vi√™n:</span>
                        <span className="font-medium">
                          {state.teachers.find(t => t.id === formData.teacherId)?.fullName || 'Ch∆∞a ch·ªçn'}
                        </span>
                      </div>
                      <div className="flex justify-between">
                        <span className="text-gray-600">S·ªë h·ªçc vi√™n t·ªëi ƒëa:</span>
                        <span className="font-medium">{formData.maxStudents}</span>
                      </div>
                    </div>
                  </div>

                  <div className="bg-blue-50 p-4 rounded-lg">
                    <h4 className="font-medium text-blue-900 mb-3">üìÖ L·ªãch h·ªçc</h4>
                    <div className="space-y-2 text-sm">
                      <div className="flex justify-between">
                        <span className="text-blue-700">S·ªë ti·∫øt h·ªçc:</span>
                        <span className="font-medium">{state.schedule.length}</span>
                      </div>
                      <div className="flex justify-between">
                        <span className="text-blue-700">Ti·∫øt c√≥ ph√≤ng:</span>
                        <span className="font-medium">
                          {state.schedule.filter(s => s.room).length} / {state.schedule.length}
                        </span>
                      </div>
                    </div>
                  </div>
                </div>

                <div className="space-y-4">
                  <div className="bg-yellow-50 p-4 rounded-lg">
                    <h4 className="font-medium text-yellow-900 mb-3">‚ö†Ô∏è Ki·ªÉm tra cu·ªëi c√πng</h4>
                    <div className="space-y-2 text-sm">
                      <div className="flex items-center">
                        <span className={`mr-2 ${formData.className ? 'text-green-600' : 'text-red-600'}`}>
                          {formData.className ? '‚úì' : '‚úó'}
                        </span>
                        <span>T√™n l·ªõp h·ªçc</span>
                      </div>
                      <div className="flex items-center">
                        <span className={`mr-2 ${formData.teacherId ? 'text-green-600' : 'text-red-600'}`}>
                          {formData.teacherId ? '‚úì' : '‚úó'}
                        </span>
                        <span>Gi√°o vi√™n ph·ª• tr√°ch</span>
                      </div>
                      <div className="flex items-center">
                        <span className={`mr-2 ${state.schedule.length > 0 ? 'text-green-600' : 'text-red-600'}`}>
                          {state.schedule.length > 0 ? '‚úì' : '‚úó'}
                        </span>
                        <span>L·ªãch h·ªçc ƒë√£ thi·∫øt l·∫≠p</span>
                      </div>
                      {(() => {
                        const hasConflicts = (state.conflicts?.length || 0) > 0 || state.scheduleValidation?.isValid === false;
                        return (
                          <div className="flex items-center">
                            <span className={`mr-2 ${!hasConflicts ? 'text-green-600' : 'text-red-600'}`}>
                              {!hasConflicts ? '‚úì' : '‚úó'}
                            </span>
                            <span>
                              {state.loading.conflicts ? 'ƒêang ki·ªÉm tra xung ƒë·ªôt...' : (!hasConflicts ? 'Kh√¥ng c√≥ xung ƒë·ªôt l·ªãch' : 'ƒêang c√≥ xung ƒë·ªôt l·ªãch')}
                            </span>
                          </div>
                        );
                      })()}
                    </div>
                  </div>

                  {state.scheduleValidation && !state.scheduleValidation.isValid && (
                    <div className="bg-red-50 p-4 rounded-lg">
                      <h4 className="font-medium text-red-900 mb-3">üö´ V·∫•n ƒë·ªÅ c·∫ßn kh·∫Øc ph·ª•c</h4>
                      <div className="space-y-1 text-sm text-red-800">
                        {state.scheduleValidation.conflicts?.map((conflict, index) => (
                          <div key={index}>‚Ä¢ {conflict.message || conflict}</div>
                        ))}
                        {state.scheduleValidation.errors?.map((error, index) => (
                          <div key={index}>‚Ä¢ {error}</div>
                        ))}
                      </div>
                    </div>
                  )}
                </div>
              </div>
            </div>
          )}

          {/* Step Navigation Buttons */}
          <div className="flex justify-between items-center mt-8 pt-6 border-t">
            <div className="flex space-x-3">
              {state.activeStep > 1 && (
                <button
                  onClick={() => goToStep(state.activeStep - 1)}
                  className="px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50"
                >
                  ‚Üê Quay l·∫°i
                </button>
              )}
            </div>

            <div className="flex space-x-3">
              <button
                onClick={handleCancel}
                className="px-6 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50"
              >
                H·ªßy
              </button>
              
              {state.activeStep < 3 ? (
                <button
                  onClick={() => goToStep(state.activeStep + 1)}
                  className="px-6 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700"
                >
                  Ti·∫øp t·ª•c ‚Üí
                </button>
              ) : (
                <button
                  onClick={handleSubmit}
                  disabled={state.loading.submit || 
                    !formData.className || 
                    !formData.teacherId || 
                    state.schedule.length === 0}
                  className="px-6 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 disabled:opacity-50 disabled:cursor-not-allowed flex items-center"
                >
                  {state.loading.submit ? (
                    <>
                      <div className="animate-spin rounded-full h-4 w-4 border-b-2 border-white mr-2"></div>
                      ƒêang t·∫°o...
                    </>
                  ) : (
                    <>
                      <span className="mr-2">üéØ</span>
                      T·∫°o l·ªõp h·ªçc
                    </>
                  )}
                </button>
              )}
            </div>
          </div>
        </div>
      </div>
    </div>
  );
};

export default CreateClassModal;